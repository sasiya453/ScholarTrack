<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ScholarTrack - Personal Productivity Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- FIX: Correct Supabase SDK UMD build -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <style>
    .gradient-bg{background:linear-gradient(135deg,#6366f1 0%,#8b5cf6 100%)}
    .glass-effect{background:rgba(255,255,255,.1);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.2)}
    .chart-container{position:relative;height:400px;width:100%}
    .toggle-btn{transition:all .3s ease}
    .toggle-btn.active{background-color:#4f46e5;color:#fff}
    .metric-card{transition:transform .3s ease}
    .metric-card:hover{transform:translateY(-5px)}
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <!-- Navigation -->
  <nav class="gradient-bg text-white shadow-lg">
    <div class="container mx-auto px-4 py-3 flex justify-between items-center">
      <div class="flex items-center space-x-2">
        <i class="fas fa-chart-line text-2xl"></i>
        <span class="text-xl font-bold">ScholarTrack</span>
      </div>
      <div id="auth-buttons" class="flex space-x-4">
        <button id="login-btn" class="px-4 py-2 rounded-lg hover:bg-indigo-700 transition">Login</button>
        <button id="signup-btn" class="px-4 py-2 bg-white text-indigo-600 rounded-lg hover:bg-gray-100 transition">Sign Up</button>
      </div>
      <div id="user-info" class="hidden flex items-center space-x-4">
        <span id="user-email" class="font-medium"></span>
        <button id="logout-btn" class="px-4 py-2 bg-white text-indigo-600 rounded-lg hover:bg-gray-100 transition">Logout</button>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="container mx-auto px-4 py-8">
    <!-- Hero Section -->
    <section class="mb-12 text-center">
      <h1 class="text-4xl font-bold text-gray-800 mb-4">Track Your Learning Journey</h1>
      <p class="text-xl text-gray-600 max-w-2xl mx-auto">
        Monitor your study habits, screen time, and academic performance with our intuitive dashboard. 
        Transform data into insights and achieve your learning goals.
      </p>
    </section>

    <!-- Auth Section -->
    <section id="auth-section" class="max-w-md mx-auto bg-white rounded-xl shadow-md p-6 mb-12">
      <div id="login-form" class="auth-form">
        <h2 class="text-2xl font-bold text-gray-800 mb-6">Login to Your Account</h2>
        <div class="mb-4">
          <label class="block text-gray-700 mb-2" for="login-email">Email</label>
          <input type="email" id="login-email" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required />
        </div>
        <div class="mb-6">
          <label class="block text-gray-700 mb-2" for="login-password">Password</label>
          <input type="password" id="login-password" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required />
        </div>
        <button id="login-submit" class="w-full bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700 transition">Login</button>
        <p class="mt-4 text-center text-gray-600">
          Don't have an account? <a href="#" id="show-signup" class="text-indigo-600 hover:underline">Sign Up</a>
        </p>
      </div>

      <div id="signup-form" class="auth-form hidden">
        <h2 class="text-2xl font-bold text-gray-800 mb-6">Create Your Account</h2>
        <div class="mb-4">
          <label class="block text-gray-700 mb-2" for="signup-email">Email</label>
          <input type="email" id="signup-email" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required />
        </div>
        <div class="mb-4">
          <label class="block text-gray-700 mb-2" for="signup-password">Password</label>
          <input type="password" id="signup-password" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required />
        </div>
        <div class="mb-6">
          <label class="block text-gray-700 mb-2" for="signup-confirm">Confirm Password</label>
          <input type="password" id="signup-confirm" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required />
        </div>
        <button id="signup-submit" class="w-full bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700 transition">Sign Up</button>
        <p class="mt-4 text-center text-gray-600">
          Already have an account? <a href="#" id="show-login" class="text-indigo-600 hover:underline">Login</a>
        </p>
      </div>
    </section>

    <!-- Dashboard Section -->
    <section id="dashboard" class="hidden">
      <!-- Metrics Input Section -->
      <div class="bg-white rounded-xl shadow-md p-6 mb-8">
        <h2 class="text-2xl font-bold text-gray-800 mb-6">Log Today's Metrics</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div class="metric-card bg-indigo-50 rounded-lg p-4">
            <div class="flex items-center mb-3">
              <i class="fas fa-book text-indigo-600 text-xl mr-2"></i>
              <h3 class="text-lg font-semibold text-gray-800">Study Time</h3>
            </div>
            <div class="flex items-center">
              <input type="number" id="study-hours" min="0" max="23" class="w-20 px-3 py-2 border rounded-l-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Hours">
              <span class="bg-gray-200 px-3 py-2">:</span>
              <input type="number" id="study-minutes" min="0" max="59" class="w-20 px-3 py-2 border rounded-r-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Min">
            </div>
          </div>

          <div class="metric-card bg-purple-50 rounded-lg p-4">
            <div class="flex items-center mb-3">
              <i class="fas fa-mobile-alt text-purple-600 text-xl mr-2"></i>
              <h3 class="text-lg font-semibold text-gray-800">Screen Time</h3>
            </div>
            <div class="flex items-center">
              <input type="number" id="screen-hours" min="0" max="23" class="w-20 px-3 py-2 border rounded-l-lg focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="Hours">
              <span class="bg-gray-200 px-3 py-2">:</span>
              <input type="number" id="screen-minutes" min="0" max="59" class="w-20 px-3 py-2 border rounded-r-lg focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="Min">
            </div>
          </div>

          <div class="metric-card bg-pink-50 rounded-lg p-4">
            <div class="flex items-center mb-3">
              <i class="fas fa-tasks text-pink-600 text-xl mr-2"></i>
              <h3 class="text-lg font-semibold text-gray-800">MCQ Marks</h3>
            </div>
            <div class="flex items-center">
              <input type="number" id="mcq-score" min="0" max="10" class="w-20 px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500" placeholder="Score">
              <span class="ml-2 text-gray-600">/10</span>
            </div>
          </div>
        </div>
        <div class="mt-6 text-center">
          <button id="save-metrics" class="px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
            <i class="fas fa-save mr-2"></i>Save Today's Metrics
          </button>
        </div>
      </div>

      <!-- Chart Section -->
      <div class="bg-white rounded-xl shadow-md p-6 mb-8">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
          <h2 class="text-2xl font-bold text-gray-800 mb-4 md:mb-0">Performance Dashboard</h2>
          <div class="flex flex-wrap gap-2">
            <button class="toggle-btn px-4 py-2 bg-gray-200 rounded-lg active" data-metric="study">
              <i class="fas fa-book mr-1"></i> Study Time
            </button>
            <button class="toggle-btn px-4 py-2 bg-gray-200 rounded-lg active" data-metric="screen">
              <i class="fas fa-mobile-alt mr-1"></i> Screen Time
            </button>
            <button class="toggle-btn px-4 py-2 bg-gray-200 rounded-lg active" data-metric="mcq">
              <i class="fas fa-tasks mr-1"></i> MCQ Marks
            </button>
          </div>
        </div>
        <div class="chart-container">
          <canvas id="performance-chart"></canvas>
        </div>
      </div>

      <!-- Stats Section -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <div class="bg-gradient-to-r from-indigo-500 to-purple-600 text-white rounded-xl shadow-md p-6">
          <div class="flex justify-between items-center">
            <div>
              <p class="text-indigo-100">Avg. Study Time</p>
              <p class="text-3xl font-bold" id="avg-study">0h 0m</p>
            </div>
            <i class="fas fa-book text-4xl text-indigo-200"></i>
          </div>
        </div>
        <div class="bg-gradient-to-r from-purple-500 to-pink-600 text-white rounded-xl shadow-md p-6">
          <div class="flex justify-between items-center">
            <div>
              <p class="text-purple-100">Avg. Screen Time</p>
              <p class="text-3xl font-bold" id="avg-screen">0h 0m</p>
            </div>
            <i class="fas fa-mobile-alt text-4xl text-purple-200"></i>
          </div>
        </div>
        <div class="bg-gradient-to-r from-pink-500 to-rose-600 text-white rounded-xl shadow-md p-6">
          <div class="flex justify-between items-center">
            <div>
              <p class="text-pink-100">Avg. MCQ Score</p>
              <p class="text-3xl font-bold" id="avg-mcq">0/10</p>
            </div>
            <i class="fas fa-tasks text-4xl text-pink-200"></i>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Footer -->
  <footer class="gradient-bg text-white py-8">
    <div class="container mx-auto px-4 text-center">
      <p>Â© 2025 ScholarTrack. Empowering students to achieve their learning goals.</p>
    </div>
  </footer>

  <!-- Notification Toast -->
  <div id="notification" class="fixed bottom-4 right-4 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg opacity-0 transform translate-y-4 transition-all duration-300">
    <span id="notification-message"></span>
  </div>

  <script>
    // Supabase client (anon key is safe to use in the browser)
    const supabaseUrl = 'https://cccbhmfieuwxjkwuuueh.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNjY2JobWZpZXV3eGprd3V1dWVoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYzODU2OTAsImV4cCI6MjA3MTk2MTY5MH0.yl-FNSDQ-06xICQVjt_1y47bFL6jQuYWsxvl4i0GteU';
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

    // DOM
    const loginBtn = document.getElementById('login-btn');
    const signupBtn = document.getElementById('signup-btn');
    const logoutBtn = document.getElementById('logout-btn');
    const authButtons = document.getElementById('auth-buttons');
    const userInfo = document.getElementById('user-info');
    const userEmail = document.getElementById('user-email');
    const authSection = document.getElementById('auth-section');
    const dashboard = document.getElementById('dashboard');
    const loginForm = document.getElementById('login-form');
    const signupForm = document.getElementById('signup-form');
    const showSignup = document.getElementById('show-signup');
    const showLogin = document.getElementById('show-login');
    const loginSubmit = document.getElementById('login-submit');
    const signupSubmit = document.getElementById('signup-submit');
    const saveMetricsBtn = document.getElementById('save-metrics');
    const notification = document.getElementById('notification');
    const notificationMessage = document.getElementById('notification-message');

    // Chart
    let performanceChart;
    const chartData = {
      labels: [],
      datasets: [
        {
          label: 'Study Time (minutes)',
          data: [],
          borderColor: 'rgb(99, 102, 241)',
          backgroundColor: 'rgba(99, 102, 241, 0.1)',
          tension: 0.3,
          hidden: false
        },
        {
          label: 'Screen Time (minutes)',
          data: [],
          borderColor: 'rgb(139, 92, 246)',
          backgroundColor: 'rgba(139, 92, 246, 0.1)',
          tension: 0.3,
          hidden: false
        },
        {
          label: 'MCQ Marks',
          data: [],
          borderColor: 'rgb(236, 72, 153)',
          backgroundColor: 'rgba(236, 72, 153, 0.1)',
          tension: 0.3,
          yAxisID: 'y1',
          hidden: false
        }
      ]
    };

    // Helpers
    function showNotification(message, type = 'success') {
      notificationMessage.textContent = message;
      notification.classList.remove('opacity-0', 'translate-y-4');
      notification.classList.add(type === 'success' ? 'bg-green-600' : 'bg-red-600');
      notification.style.opacity = '1';
      notification.style.transform = 'translateY(0)';

      setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transform = 'translateY(1rem)';
      }, 3000);
    }

    function showDashboard(user) {
      authSection.classList.add('hidden');
      dashboard.classList.remove('hidden');
      authButtons.classList.add('hidden');
      userInfo.classList.remove('hidden');
      userEmail.textContent = user.email;
      if (!performanceChart) initChart();
      loadUserData();
    }

    function showAuthSection() {
      authSection.classList.remove('hidden');
      dashboard.classList.add('hidden');
      authButtons.classList.remove('hidden');
      userInfo.classList.add('hidden');
    }

    // Toggle forms
    function openLogin() {
      signupForm.classList.add('hidden');
      loginForm.classList.remove('hidden');
      window.scrollTo({ top: authSection.offsetTop - 20, behavior: 'smooth' });
    }
    function openSignup() {
      loginForm.classList.add('hidden');
      signupForm.classList.remove('hidden');
      window.scrollTo({ top: authSection.offsetTop - 20, behavior: 'smooth' });
    }

    showSignup.addEventListener('click', e => { e.preventDefault(); openSignup(); });
    showLogin.addEventListener('click', e => { e.preventDefault(); openLogin(); });
    loginBtn.addEventListener('click', openLogin);
    signupBtn.addEventListener('click', openSignup);

    // Auth state handling
    supabase.auth.onAuthStateChange((event, session) => {
      if (event === 'SIGNED_IN' && session?.user) {
        showNotification('Login successful!');
        showDashboard(session.user);
      }
      if (event === 'SIGNED_OUT') {
        showNotification('Logged out successfully');
        showAuthSection();
      }
    });

    // Initial session check
    (async function init() {
      const { data: { session }, error } = await supabase.auth.getSession();
      if (error) console.error(error);
      if (session?.user) showDashboard(session.user);
      else showAuthSection();
    })();

    // Login
    loginSubmit.addEventListener('click', async (e) => {
      e.preventDefault();
      const email = document.getElementById('login-email').value.trim();
      const password = document.getElementById('login-password').value;
      if (!email || !password) return showNotification('Please enter both email and password', 'error');

      const { error } = await supabase.auth.signInWithPassword({ email, password });
      if (error) showNotification(error.message, 'error');
      // Success flows through onAuthStateChange
    });

    // Signup
    signupSubmit.addEventListener('click', async (e) => {
      e.preventDefault();
      const email = document.getElementById('signup-email').value.trim();
      const password = document.getElementById('signup-password').value;
      const confirmPassword = document.getElementById('signup-confirm').value;
      if (!email || !password || !confirmPassword) return showNotification('Please fill all fields', 'error');
      if (password !== confirmPassword) return showNotification('Passwords do not match', 'error');

      const { error } = await supabase.auth.signUp({
        email,
        password,
        options: { emailRedirectTo: window.location.origin + '/?verified=1' }
      });
      if (error) return showNotification(error.message, 'error');

      showNotification('Signup successful! Check your email to verify your account.');
      document.getElementById('signup-email').value = '';
      document.getElementById('signup-password').value = '';
      document.getElementById('signup-confirm').value = '';
      openLogin();
    });

    // Logout
    logoutBtn.addEventListener('click', async () => {
      const { error } = await supabase.auth.signOut();
      if (error) showNotification(error.message, 'error');
    });

    // Chart
    function initChart() {
      const ctx = document.getElementById('performance-chart').getContext('2d');
      performanceChart = new Chart(ctx, {
        type: 'line',
        data: chartData,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          animation: { duration: 600, easing: 'easeOutQuart' },
          interaction: { mode: 'index', intersect: false },
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: 'rgba(0,0,0,0.7)',
              titleFont: { size: 14 },
              bodyFont: { size: 14 },
              padding: 10,
              displayColors: true,
              callbacks: {
                label: function (context) {
                  let label = context.dataset.label ? context.dataset.label + ': ' : '';
                  if (context.dataset.label === 'MCQ Marks') {
                    label += context.parsed.y + '/10';
                  } else {
                    const hours = Math.floor(context.parsed.y / 60);
                    const minutes = context.parsed.y % 60;
                    label += `${hours}h ${minutes}m`;
                  }
                  return label;
                }
              }
            }
          },
          scales: {
            y: {
              type: 'linear',
              display: true,
              position: 'left',
              title: { display: true, text: 'Time (minutes)' },
              ticks: {
                callback: (value) => {
                  const hours = Math.floor(value / 60);
                  const minutes = value % 60;
                  return `${hours}h ${minutes}m`;
                }
              }
            },
            y1: {
              type: 'linear',
              display: true,
              position: 'right',
              title: { display: true, text: 'MCQ Marks' },
              min: 0,
              max: 10,
              grid: { drawOnChartArea: false }
            }
          }
        }
      });

      // Toggle visibility buttons
      document.querySelectorAll('.toggle-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const metric = btn.getAttribute('data-metric');
          const index = metric === 'study' ? 0 : metric === 'screen' ? 1 : 2;
          const ds = performanceChart.data.datasets[index];
          ds.hidden = !ds.hidden;
          btn.classList.toggle('active');
          performanceChart.update();
        });
      });
    }

    // Load metrics for current user
    async function loadUserData() {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) return;

      const { data, error } = await supabase
        .from('user_metrics')
        .select('date,study_time_minutes,screen_time_minutes,mcq_marks')
        .eq('user_id', user.id)
        .order('date', { ascending: true });

      if (error) {
        showNotification('Error loading data: ' + error.message, 'error');
        return;
      }

      // Reset chart data
      chartData.labels = [];
      chartData.datasets[0].data = [];
      chartData.datasets[1].data = [];
      chartData.datasets[2].data = [];

      // Populate chart
      data.forEach(row => {
        const d = new Date(row.date);
        const label = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        chartData.labels.push(label);
        chartData.datasets[0].data.push(row.study_time_minutes || 0);
        chartData.datasets[1].data.push(row.screen_time_minutes || 0);
        chartData.datasets[2].data.push(row.mcq_marks || 0);
      });

      if (performanceChart) performanceChart.update();
      calculateAverages(data);
    }

    function calculateAverages(rows) {
      if (!rows || rows.length === 0) {
        document.getElementById('avg-study').textContent = '0h 0m';
        document.getElementById('avg-screen').textContent = '0h 0m';
        document.getElementById('avg-mcq').textContent = '0/10';
        return;
      }
      const totalStudy = rows.reduce((s, r) => s + (r.study_time_minutes || 0), 0);
      const totalScreen = rows.reduce((s, r) => s + (r.screen_time_minutes || 0), 0);
      const totalMCQ = rows.reduce((s, r) => s + (r.mcq_marks || 0), 0);

      const avgStudy = Math.round(totalStudy / rows.length);
      const avgScreen = Math.round(totalScreen / rows.length);
      const avgMCQ = (totalMCQ / rows.length).toFixed(1);

      const sh = Math.floor(avgStudy / 60), sm = avgStudy % 60;
      const sch = Math.floor(avgScreen / 60), scm = avgScreen % 60;

      document.getElementById('avg-study').textContent = `${sh}h ${sm}m`;
      document.getElementById('avg-screen').textContent = `${sch}h ${scm}m`;
      document.getElementById('avg-mcq').textContent = `${avgMCQ}/10`;
    }

    // Save metrics (upsert by user_id + date)
    saveMetricsBtn.addEventListener('click', async () => {
      const studyHours = parseInt(document.getElementById('study-hours').value) || 0;
      const studyMinutes = parseInt(document.getElementById('study-minutes').value) || 0;
      const screenHours = parseInt(document.getElementById('screen-hours').value) || 0;
      const screenMinutes = parseInt(document.getElementById('screen-minutes').value) || 0;
      let mcqScore = parseInt(document.getElementById('mcq-score').value);
      if (isNaN(mcqScore)) mcqScore = 0;
      mcqScore = Math.max(0, Math.min(10, mcqScore));

      const studyTimeMinutes = studyHours * 60 + studyMinutes;
      const screenTimeMinutes = screenHours * 60 + screenMinutes;

      if (studyTimeMinutes === 0 && screenTimeMinutes === 0 && mcqScore === 0) {
        return showNotification('Please enter at least one metric', 'error');
      }

      const { data: { user } } = await supabase.auth.getUser();
      if (!user) return showNotification('You must be logged in to save metrics', 'error');

      // FIX: use local date to avoid UTC offset issues; format YYYY-MM-DD
      const todayLocal = new Date().toLocaleDateString('en-CA'); // e.g., 2025-08-28

      // FIX: upsert with unique constraint to avoid duplicates
      const { error } = await supabase
        .from('user_metrics')
        .upsert({
          user_id: user.id,
          date: todayLocal,
          study_time_minutes: studyTimeMinutes,
          screen_time_minutes: screenTimeMinutes,
          mcq_marks: mcqScore
        }, { onConflict: 'user_id,date' });

      if (error) {
        showNotification('Error saving metrics: ' + error.message, 'error');
      } else {
        showNotification('Metrics saved!');
        // Reset form
        document.getElementById('study-hours').value = '';
        document.getElementById('study-minutes').value = '';
        document.getElementById('screen-hours').value = '';
        document.getElementById('screen-minutes').value = '';
        document.getElementById('mcq-score').value = '';
        loadUserData();
      }
    });
  </script>
</body>
</html>
